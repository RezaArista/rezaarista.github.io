<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üå± Dashboard Pompa IoT</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Segoe UI', Arial; background:#f4f7f9; margin:0; padding:20px; text-align:center;}
h1 { color:#2c3e50; }
.box { background:white; padding:20px; margin:10px; border-radius:15px; display:inline-block; min-width:200px; box-shadow:0 4px 8px rgba(0,0,0,0.1);}
.on { color:green; font-weight:bold; font-size:1.2em;}
.off { color:red; font-weight:bold; font-size:1.2em;}
button { padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
button.on { background:green; color:white; }
button.off { background:red; color:white; }
input { padding:5px; width:80px; border-radius:5px; border:1px solid #ccc; text-align:center; }
#chartContainer { width:90%; max-width:700px; margin:20px auto;}
</style>
</head>
<body>

<h1>üå± Dashboard IoT Pompa</h1>

<div class="box">
  Soil Moisture:<br><b id="soil">--</b>
</div>
<div class="box">
  Pompa Status:<br><b id="pump" class="off">--</b><br>
  <button class="on" onclick="setPump('ON')">Nyalakan</button>
  <button class="off" onclick="setPump('OFF')">Matikan</button>
</div>
<div class="box">
  Jadwal 1:<br><input id="jadwal1Input" type="time" value="06:00">
  <button onclick="setJadwal(1)">Update</button><br>
  <span id="jadwal1">--</span>
</div>
<div class="box">
  Jadwal 2:<br><input id="jadwal2Input" type="time" value="18:00">
  <button onclick="setJadwal(2)">Update</button><br>
  <span id="jadwal2">--</span>
</div>
<div class="box">
  Waktu:<br><span id="waktu">--:--:--</span>
</div>

<div id="chartContainer">
  <canvas id="soilChart"></canvas>
</div>

<script>
const broker = "wss://cec6834af4594d7b9687f68dafb48b42.s1.eu.hivemq.cloud:8884/mqtt";
const options = {
  clientId: "webclient_" + Math.random().toString(16).substr(2, 8),
  username: "Pompa1",
  password: "Pompa1234",
  clean: true,
  reconnectPeriod: 2000
};
const client = mqtt.connect(broker, options);

const topicSoil = "iot/pompa/soil";
const topicPump = "iot/pompa/status";
const topicPumpControl = "iot/pompa/control";
const topicJadwal1 = "iot/pompa/jadwal1";
const topicJadwal2 = "iot/pompa/jadwal2";
const topicJadwal1Set = "iot/pompa/jadwal1/set";
const topicJadwal2Set = "iot/pompa/jadwal2/set";

// Chart
const ctx = document.getElementById('soilChart').getContext('2d');
const soilChart = new Chart(ctx, {
    type: 'line',
    data: { 
        labels: [], 
        datasets: [{ 
            label: 'Soil Moisture', 
            data: [], 
            borderColor: '#2ecc71', 
            backgroundColor: 'rgba(46, 204, 113,0.2)', 
            fill: true, 
            tension: 0.3 
        }] 
    },
    options: { 
        responsive:true, 
        animation: {duration:0}, 
        scales: { y: { min: 0, max: 5000 } } 
    }
});

const googleSheetUrl = 'https://script.google.com/macros/s/AKfycbzia5jifJ9H05AeDUUjs2so983uTe8LpEFm8ddQGHLkJq1Ttizsgp4fIuvJgKH-suH2sw/exec';

async function fetchSheetData() {
    try {
        const res = await fetch(googleSheetUrl);
        return await res.json();
    } catch (err) {
        console.error("‚ùå Gagal ambil data dari Sheet", err);
        return [];
    }
}

// === Bagian Chart ===
async function updateDashboard() {
    const data = await fetchSheetData();
    if(data.length === 0) return;

    // ===== Group data per jam =====
    const grouped = {};
    data.forEach(d => {
        const t = new Date(d.time_Stamp);
        const hour = t.getHours();
        if(!grouped[hour]) grouped[hour] = [];
        grouped[hour].push(Number(d[topicSoil] || 0));
    });

    const hours = Object.keys(grouped).sort((a,b)=>a-b);
    const values = hours.map(h => {
        const arr = grouped[h];
        const avg = arr.reduce((sum,v)=>sum+v,0)/arr.length;
        return Math.round(avg);
    });

    // Update chart per jam
    soilChart.data.labels = hours.map(h => h + ":00");
    soilChart.data.datasets[0].data = values;
    soilChart.update();

    // Update latest value realtime
    const latest = data[data.length-1];
    document.getElementById("soil").innerText = latest[topicSoil] || '--';
    document.getElementById("waktu").innerText = new Date().toLocaleTimeString();
}

// MQTT Handlers
client.on("connect", () => {
    console.log("‚úÖ Connected to MQTT Broker");
    client.subscribe([topicSoil, topicPump, topicJadwal1, topicJadwal2]);
});

client.on("message", (topic, message) => {
    const msg = message.toString();
    const now = new Date();
    document.getElementById("waktu").innerText = now.toLocaleTimeString();

    if(topic === topicSoil){
        const now = new Date();
    if(now.getMinutes() === 0 && now.getSeconds() < 5){ // hanya saat awal jam
        soilChart.data.labels.push(now.getHours() + ":00");
        soilChart.data.datasets[0].data.push(parseInt(message.toString()));
        if(soilChart.data.labels.length > 24){
            soilChart.data.labels.shift();
            soilChart.data.datasets[0].data.shift();
        }
        soilChart.update();
        }
    }

    if(topic === topicPump){
        const pumpEl = document.getElementById("pump");

        if (msg === "ON") {
            pumpEl.innerText = "MENYALA";
            pumpEl.className = "on";
        } else if (msg === "OFF") {
            pumpEl.innerText = "MATI";
            pumpEl.className = "off";
        } else if (msg.includes("TERJADWAL")) {
            pumpEl.innerText = "‚è∞ " + msg; // tampil: ‚è∞ PENYIRAMAN TERJADWAL
            pumpEl.className = "on";
        } else {
            pumpEl.innerText = msg;
            pumpEl.className = "off";
        }
    }


    if(topic === topicJadwal1){
        document.getElementById("jadwal1").innerText = msg;
        document.getElementById("jadwal1Input").value = msg;
    }

    if(topic === topicJadwal2){
        document.getElementById("jadwal2").innerText = msg;
        document.getElementById("jadwal2Input").value = msg;
    }
});

client.on("error", (err) => console.error("‚ùå MQTT Error", err));

function setPump(state){
    client.publish(topicPumpControl, state, {retain:true, qos:1});
    const pumpEl = document.getElementById("pump");
    pumpEl.innerText = state;
    pumpEl.className = state==="ON"?"on":"off";
}

function setJadwal(num){
    const value = document.getElementById(`jadwal${num}Input`).value;
    const topic = num===1 ? topicJadwal1Set : topicJadwal2Set;
    client.publish(topic, value, {retain:true});
}

// Refresh Sheet tiap 15 detik
updateDashboard();
setInterval(updateDashboard, 15000);

</script>
</body>
</html>
