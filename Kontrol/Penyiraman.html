<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üå± Dashboard Pompa IoT</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Segoe UI', Arial; background:#f4f7f9; margin:0; padding:20px; text-align:center;}
h1 { color:#2c3e50; }
.box { background:white; padding:20px; margin:10px; border-radius:15px; display:inline-block; min-width:200px; box-shadow:0 4px 8px rgba(0,0,0,0.1);}
.on { color:green; font-weight:bold; font-size:1.2em;}
.off { color:red; font-weight:bold; font-size:1.2em;}
button { padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
button.on { background:green; color:white; }
button.off { background:red; color:white; }
input { padding:5px; width:80px; border-radius:5px; border:1px solid #ccc; text-align:center; }
input[type="number"] { width:60px; }
#chartContainer { width:90%; max-width:700px; margin:20px auto;}
.water-container {
  position: relative;
  width: 180px;
  height: 180px;
  border-radius: 50%;
  overflow: hidden;
  margin: 20px auto;
  background: #ddd;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
}
.water {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background: linear-gradient(to top, #3498db, #5dade2);
  transition: height 1s ease-in-out, background 0.5s;
  border-top-left-radius: 50%;
  border-top-right-radius: 50%;
  overflow: hidden;
}
.wave {
  position: absolute;
  top: -10px;
  width: 200%;
  height: 20px;
  background: rgba(255,255,255,0.3);
  border-radius: 100%;
  animation: wave 2s infinite linear;
}
@keyframes wave {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}
.water-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: #2c3e50;
  font-weight: bold;
  font-size: 1.2em;
}
</style>
</head>
<body>

<h1>üå± Dashboard IoT Pompa</h1>

<div style="display:flex; justify-content:center; flex-wrap:wrap; gap:4px;">
  <!-- Soil Moisture -->
  <div class="water-container" id="soilContainer">
    <div class="water" id="soilWater"><div class="wave"></div></div>
    <div class="water-text">
      <div id="soilStatus" style="font-size:0.9em; color:gray;">üîÑ Checking...</div>
      Soil Moisture<br><b id="soil">--%</b>
    </div>
  </div>

  <!-- Water Level -->
  <div class="water-container" id="waterContainer">
    <div class="water" id="waterLevel"><div class="wave"></div></div>
    <div class="water-text">
      <div id="waterStatus" style="font-size:0.9em; color:gray;">üîÑ Checking...</div>
      Water Level<br><b id="water">--%</b>
    </div>
  </div>
</div>



<div class="box">
  Pompa Status:<br><b id="pump" class="off">--</b><br>
  <button class="on" onclick="setPump('ON')">Nyalakan</button>
  <button class="off" onclick="setPump('OFF')">Matikan</button>
</div>

<!-- Jadwal 1 -->
<div class="box">
  Jadwal 1:<br>
  <input id="jadwal1Input" type="time" value="06:00">
  <input id="durasi1" type="number" value="10" min="1" max="300"> dtk<br>
  <label><input type="checkbox" id="enable1" onchange="toggleEnable(1)"> Aktifkan</label><br>
  <button onclick="setJadwal(1)">Update</button><br>
  <span id="jadwal1">--</span>
</div>

<!-- Jadwal 2 -->
<div class="box">
  Jadwal 2:<br>
  <input id="jadwal2Input" type="time" value="18:00">
  <input id="durasi2" type="number" value="10" min="1" max="300"> dtk<br>
  <label><input type="checkbox" id="enable2" onchange="toggleEnable(2)"> Aktifkan</label><br>
  <button onclick="setJadwal(2)">Update</button><br>
  <span id="jadwal2">--</span>
</div>

<!-- Jadwal 3 -->
<div class="box">
  Jadwal 3:<br>
  <input id="jadwal3Input" type="time" value="09:00">
  <input id="durasi3" type="number" value="10" min="1" max="300"> dtk<br>
  <label><input type="checkbox" id="enable3" onchange="toggleEnable(3)"> Aktifkan</label><br>
  <button onclick="setJadwal(3)">Update</button><br>
  <span id="jadwal3">--</span>
</div>

<!-- Jadwal 4 -->
<div class="box">
  Jadwal 4:<br>
  <input id="jadwal4Input" type="time" value="15:00">
  <input id="durasi4" type="number" value="10" min="1" max="300"> dtk<br>
  <label><input type="checkbox" id="enable4" onchange="toggleEnable(4)"> Aktifkan</label><br>
  <button onclick="setJadwal(4)">Update</button><br>
  <span id="jadwal4">--</span>
</div>

<div class="box">
  Waktu:<br><span id="waktu">--:--:--</span>
</div>

<div id="chartContainer">
  <canvas id="soilChart"></canvas>
</div>

<script>
const broker = "wss://cec6834af4594d7b9687f68dafb48b42.s1.eu.hivemq.cloud:8884/mqtt";
const options = {
  clientId: "webclient_" + Math.random().toString(16).substr(2, 8),
  username: "Pompa1",
  password: "Pompa1234",
  clean: true,
  reconnectPeriod: 2000
};
const client = mqtt.connect(broker, options);

// ===== Topic MQTT =====
const topicWater = "iot/pompa/water";
const topicSoil = "iot/pompa/soil";
const topicPump = "iot/pompa/status";
const topicPumpControl = "iot/pompa/control";
const topicJadwal1 = "iot/pompa/jadwal1";
const topicJadwal2 = "iot/pompa/jadwal2";
const topicJadwal3 = "iot/pompa/jadwal3";
const topicJadwal4 = "iot/pompa/jadwal4";
const topicJadwal1Set = "iot/pompa/jadwal1/set";
const topicJadwal2Set = "iot/pompa/jadwal2/set";
const topicJadwal3Set = "iot/pompa/jadwal3/set";
const topicJadwal4Set = "iot/pompa/jadwal4/set";

// === Tambahan: topic enable jadwal ===
const topicEnable1 = "iot/pompa/jadwal1/enable";
const topicEnable2 = "iot/pompa/jadwal2/enable";
const topicEnable3 = "iot/pompa/jadwal3/enable";
const topicEnable4 = "iot/pompa/jadwal4/enable";

// ===== Chart Soil Moisture =====
const ctx = document.getElementById('soilChart').getContext('2d');
const soilChart = new Chart(ctx, {
    type: 'line',
    data: { 
        labels: [], 
        datasets: [{ 
            label: 'Soil Moisture', 
            data: [], 
            borderColor: '#2ecc71', 
            backgroundColor: 'rgba(46, 204, 113,0.2)', 
            fill: true, 
            tension: 0.3 
        }] 
    },
    options: { 
        responsive:true, 
        animation: {duration:0}, 
        scales: { y: { min: 0, max: 100 } } 
    }
});

const googleSheetUrl = 'https://script.google.com/macros/s/AKfycbzia5jifJ9H05AeDUUjs2so983uTe8LpEFm8ddQGHLkJq1Ttizsgp4fIuvJgKH-suH2sw/exec';
const riwayatSheet = 'https://script.google.com/macros/s/AKfycbyyj2ZQnOHyc9Gqn2uwnbHXrWGFun6h1sPQylqMca-wFV4NeLxqsDvRpPKsy3W3VHLgvQ/exec';

async function fetchSheetData() {
    try {
        const res = await fetch(googleSheetUrl);
        return await res.json();
    } catch (err) {
        console.error("‚ùå Gagal ambil data dari Sheet", err);
        return [];
    }
}

let realtimeSoilValue = null; // nilai terakhir dari MQTT

async function updateDashboard() {
    const data = await fetchSheetData();
    if(data.length === 0) return;

    const grouped = {};
    data.forEach(d => {
        const t = new Date(d.time_Stamp);
        const hour = t.getHours();
        if(!grouped[hour]) grouped[hour] = [];
        grouped[hour].push(Number(d[topicSoil] || 0));
    });

    const hours = Object.keys(grouped).sort((a,b)=>a-b);
    const values = hours.map(h => {
        const arr = grouped[h];
        const avg = arr.reduce((sum,v)=>sum+v,0)/arr.length;
        return Math.round(avg);
    });

    soilChart.data.labels = hours.map(h => h + ":00");
    soilChart.data.datasets[0].data = values;
    soilChart.update();

    // Gunakan nilai MQTT jika tersedia
    if (realtimeSoilValue === null) {
      const latest = data[data.length-1];
      let val = parseInt(latest[topicSoil]);
      if (isNaN(val)) val = 0;
      document.getElementById("soil").innerText = val + "%";
    }


    document.getElementById("waktu").innerText = new Date().toLocaleTimeString();
}

// === Fungsi kirim log ke Google Sheet ===
async function logToSheet(topic, message) {
  try {
    const payload = { topic, message };
    await fetch(riwayatSheet, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      mode: "cors"
    });
    console.log("üìù Log terkirim ke Sheet:", topic, message);
  } catch (err) {
    console.error("‚ùå Gagal kirim log ke Sheet:", err);
  }
}



// ===== MQTT Handling =====
client.on("connect", () => {
    console.log("‚úÖ Connected to MQTT Broker");
    client.subscribe([
      topicSoil, topicWater ,topicPump,
      topicJadwal1, topicJadwal2,
      topicJadwal3, topicJadwal4,
      topicEnable1, topicEnable2, topicEnable3, topicEnable4
    ]);
});

client.on("message", (topic, message) => {
    const msg = message.toString();
    const now = new Date();
    document.getElementById("waktu").innerText = now.toLocaleTimeString();

    if(topic === topicSoil){
        markSoilReceived();
        const value = msg.trim();
        const numValue = parseInt(value);
        if (!isNaN(numValue)) {
          realtimeSoilValue = numValue; // simpan realtime
          updateSoilLevel(numValue);
        }
      if(now.getMinutes() === 0 && now.getSeconds() < 5){
          soilChart.data.labels.push(now.getHours() + ":00");
          soilChart.data.datasets[0].data.push(value);
          if(soilChart.data.labels.length > 24){
              soilChart.data.labels.shift();
              soilChart.data.datasets[0].data.shift();
          }
          soilChart.update();
      }
    }

    if(topic === topicWater){
      markWaterReceived();
      const value = parseInt(msg);
      updateTankLevel(value);
    }


    if(topic === topicPump){
        const pumpEl = document.getElementById("pump");
        if (msg === "ON") { pumpEl.innerText="MENYALA"; pumpEl.className="on";}
        else if (msg === "OFF"){ pumpEl.innerText="MATI"; pumpEl.className="off";}
        else if (msg.includes("TERJADWAL_")){ pumpEl.innerText="‚è∞ "+msg; pumpEl.className="on";}
    }

    if(topic === topicJadwal1){ document.getElementById("jadwal1").innerText = msg; }
    if(topic === topicJadwal2){ document.getElementById("jadwal2").innerText = msg; }
    if(topic === topicJadwal3){ document.getElementById("jadwal3").innerText = msg; }
    if(topic === topicJadwal4){ document.getElementById("jadwal4").innerText = msg; }

    // === Sinkronisasi checkbox dari MQTT ===
    if(topic === topicEnable1){ document.getElementById("enable1").checked = (msg==="ON"); }
    if(topic === topicEnable2){ document.getElementById("enable2").checked = (msg==="ON"); }
    if(topic === topicEnable3){ document.getElementById("enable3").checked = (msg==="ON"); }
    if(topic === topicEnable4){ document.getElementById("enable4").checked = (msg==="ON"); }
});

function updateSoilLevel(value){
  const soilDiv = document.getElementById("soilWater");
  const soilText = document.getElementById("soil");

  let percent = parseInt(String(value).trim());
  if (isNaN(percent) || percent < 0) percent = 0;
  if (percent > 100) percent = 100;

  // animasi tinggi dan warna
  soilDiv.style.height = percent + "%";
  soilDiv.style.background = (percent <= 50)
    ? "linear-gradient(to top,#e74c3c,#ff6b6b)"   // merah jika kering
    : "linear-gradient(to top,#3498db,#5dade2)";  // biru jika lembap

  soilText.innerText = percent + "%";
  soilText.style.color = "black";
}


function updateTankLevel(value){
  const waterDiv = document.getElementById("waterLevel");
  const waterText = document.getElementById("water");

  let percent = parseInt(String(value).trim());
  if (isNaN(percent) || percent < 0) percent = 0;
  if (percent > 100) percent = 100;

  waterDiv.style.height = percent + "%";
  waterDiv.style.background = (percent <= 50)
    ? "linear-gradient(to top,#e67e22,#f39c12)"
    : "linear-gradient(to top,#1abc9c,#16a085)";

  waterText.innerText = percent + "%"; // selalu tampil %
  waterText.style.color = "black";
}




function setPump(state){
  client.publish(topicPumpControl,state,{retain:true,qos:1});
  const pumpEl=document.getElementById("pump");
  pumpEl.innerText=state;
  pumpEl.className=state==="ON"?"on":"off";

    // kirim log ke Sheet
  logToSheet("Pompa", "Pompa diubah ke " + state);  
}

function setJadwal(num){
  const jam=document.getElementById(`jadwal${num}Input`).value;
  const dur=document.getElementById(`durasi${num}`).value;
  const payload=`${jam}:${dur}`;
  const topic=eval(`topicJadwal${num}Set`);
  client.publish(topic,payload,{retain:true});
  document.getElementById(`jadwal${num}`).innerText=payload;

    // kirim log ke Sheet
  logToSheet(`Jadwal${num}`, `Jadwal ${num} diubah: ${payload}`);
}

// === Fungsi baru: aktif/nonaktif jadwal ===
function toggleEnable(num){
  const enabled=document.getElementById(`enable${num}`).checked;
  const topic=eval(`topicEnable${num}`);
  const value=enabled?"ON":"OFF";
  client.publish(topic,value,{retain:true});
  console.log(`üîò Jadwal ${num} ${value}`);
 
    // kirim log ke Sheet
  logToSheet(`Jadwal${num}/Enable`, `Status jadwal ${num}: ${value}`);  
}

// ======= Watchdog Soil Moisture (5 menit tanpa data) =======
let lastSoilUpdate = Date.now();
let soilOffline = false;

// Dipanggil tiap kali ada data soil
function markSoilReceived() {
  lastSoilUpdate = Date.now();
  if (soilOffline) {
    soilOffline = false;
  }
  document.getElementById("soilStatus").innerText = "üü¢ ONLINE";
  document.getElementById("soilStatus").style.color = "green";
}

setInterval(() => {
  const elapsed = Date.now() - lastSoilUpdate;
  if (elapsed > 300000 && !soilOffline) { // >5 menit
    soilOffline = true;
    document.getElementById("soilStatus").innerText = "üî¥ OFFLINE";
    document.getElementById("soilStatus").style.color = "red";
    document.getElementById("soil").innerText = "--";
    document.getElementById("soilWater").style.height = "0%";
    document.querySelector(".water").style.background = "gray";
  }
}, 30000);


let lastWaterUpdate = Date.now();
let waterOffline = false;

function markWaterReceived() {
  lastWaterUpdate = Date.now();
  if (waterOffline) waterOffline = false;
  document.getElementById("waterStatus").innerText = "üü¢ ONLINE";
  document.getElementById("waterStatus").style.color = "green";
}

setInterval(() => {
  const elapsed = Date.now() - lastWaterUpdate;
  if (elapsed > 300000 && !waterOffline) { // 5 menit
    waterOffline = true;
    document.getElementById("waterStatus").innerText = "üî¥ OFFLINE";
    document.getElementById("waterStatus").style.color = "red";
    document.getElementById("water").innerText = "--";
    document.getElementById("waterLevel").style.height = "0%";
    document.getElementById("waterLevel").style.background = "gray";
  }
}, 30000);



updateDashboard();
setInterval(updateDashboard,15000);
</script>
</body>
</html>
